From 6af6f541d15989ead4f4a0cef87f332079d0d583 Mon Sep 17 00:00:00 2001
From: Heinrich Schuchardt <xypron.glpk@gmx.de>
Date: Sat, 2 Sep 2017 12:35:47 +0200
Subject: [PATCH 1/1] selftest

Signed-off-by: Heinrich Schuchardt <xypron.glpk@gmx.de>
---
 arch/arm/lib/Makefile          |  1 +
 arch/x86/config.mk             |  2 +-
 arch/x86/lib/Makefile          |  2 +-
 cmd/bootefi.c                  | 23 ++++++++++++++++++++---
 include/asm-generic/sections.h |  2 ++
 lib/Makefile                   |  1 +
 lib/efi_selftest/Makefile      | 16 ++++++++++++++++
 lib/efi_selftest/selftest.c    | 24 ++++++++++++++++++++++++
 scripts/Makefile.lib           | 35 ++++++++++++++++++++++++++++++-----
 9 files changed, 96 insertions(+), 10 deletions(-)
 create mode 100644 lib/efi_selftest/Makefile
 create mode 100644 lib/efi_selftest/selftest.c

diff --git a/arch/arm/lib/Makefile b/arch/arm/lib/Makefile
index 6e1c436933..050789e12b 100644
--- a/arch/arm/lib/Makefile
+++ b/arch/arm/lib/Makefile
@@ -106,4 +106,5 @@ CFLAGS_$(EFI_RELOC) := $(CFLAGS_EFI)
 CFLAGS_REMOVE_$(EFI_RELOC) := $(CFLAGS_NON_EFI)
 
 extra-$(CONFIG_CMD_BOOTEFI_HELLO_COMPILE) += $(EFI_CRT0) $(EFI_RELOC)
+extra-$(CONFIG_CMD_SELFTEST_COMPILE) += $(EFI_CRT0) $(EFI_RELOC)
 extra-$(CONFIG_EFI) += $(EFI_CRT0) $(EFI_RELOC)
diff --git a/arch/x86/config.mk b/arch/x86/config.mk
index 8835dcf36f..fe8639aef6 100644
--- a/arch/x86/config.mk
+++ b/arch/x86/config.mk
@@ -91,7 +91,7 @@ else
 PLATFORM_CPPFLAGS += -D__I386__
 endif
 
-ifneq ($(CONFIG_EFI_STUB)$(CONFIG_CMD_BOOTEFI_HELLO_COMPILE),)
+ifneq ($(CONFIG_EFI_STUB)$(CONFIG_CMD_BOOTEFI_HELLO_COMPILE)$(CONFIG_CMD_SELFTEST_COMPILE),)
 
 ifneq ($(CONFIG_EFI_STUB_64BIT),)
 EFI_LDS := elf_x86_64_efi.lds
diff --git a/arch/x86/lib/Makefile b/arch/x86/lib/Makefile
index fe00d7573f..6575e1a0cb 100644
--- a/arch/x86/lib/Makefile
+++ b/arch/x86/lib/Makefile
@@ -77,7 +77,7 @@ extra-$(CONFIG_EFI_STUB_64BIT) += crt0_x86_64_efi.o reloc_x86_64_efi.o
 
 endif
 
-ifneq ($(CONFIG_EFI_STUB)$(CONFIG_CMD_BOOTEFI_HELLO_COMPILE),)
+ifneq ($(CONFIG_EFI_STUB)$(CONFIG_CMD_BOOTEFI_HELLO_COMPILE)$(CONFIG_CMD_SELFTEST_COMPILE),)
 ifeq ($(CONFIG_$(SPL_)X86_64),)
 extra-y += $(EFI_CRT0) $(EFI_RELOC)
 endif
diff --git a/cmd/bootefi.c b/cmd/bootefi.c
index a3768158a2..0ddf71b19c 100644
--- a/cmd/bootefi.c
+++ b/cmd/bootefi.c
@@ -290,7 +290,8 @@ static unsigned long do_bootefi_exec(void *efi, void *fdt)
 /* Interpreter command to boot an arbitrary EFI image from memory */
 static int do_bootefi(cmd_tbl_t *cmdtp, int flag, int argc, char * const argv[])
 {
-	char *saddr, *sfdt;
+	char *saddr = NULL;
+	char *sfdt;
 	unsigned long addr, fdt_addr = 0;
 	unsigned long r;
 
@@ -306,9 +307,21 @@ static int do_bootefi(cmd_tbl_t *cmdtp, int flag, int argc, char * const argv[])
 		else
 			addr = CONFIG_SYS_LOAD_ADDR;
 		memcpy((char *)addr, __efi_hello_world_begin, size);
-	} else
+	}
 #endif
-	{
+#ifdef CONFIG_CMD_BOOTEFI_SELFTEST
+	if (!strcmp(argv[1], "selftest")) {
+		ulong size = __efi_selftest_end - __efi_selftest_begin;
+
+		saddr = env_get("loadaddr");
+		if (saddr)
+			addr = simple_strtoul(saddr, NULL, 16);
+		else
+			addr = CONFIG_SYS_LOAD_ADDR;
+		memcpy((char *)addr, __efi_selftest_begin, size);
+	}
+#endif
+	if (saddr == NULL) {
 		saddr = argv[1];
 
 		addr = simple_strtoul(saddr, NULL, 16);
@@ -340,6 +353,10 @@ static char bootefi_help_text[] =
 	"hello\n"
 	"  - boot a sample Hello World application stored within U-Boot"
 #endif
+#ifdef CONFIG_CMD_BOOTEFI_SELFTEST
+	"hello\n"
+	"  - boot an EFI selftest application stored within U-Boot"
+#endif
 	;
 #endif
 
diff --git a/include/asm-generic/sections.h b/include/asm-generic/sections.h
index daf021b647..c199f3550b 100644
--- a/include/asm-generic/sections.h
+++ b/include/asm-generic/sections.h
@@ -24,6 +24,8 @@ extern char __initdata_begin[], __initdata_end[];
 extern char __start_rodata[], __end_rodata[];
 extern char __efi_hello_world_begin[];
 extern char __efi_hello_world_end[];
+extern char __efi_selftest_begin[];
+extern char __efi_selftest_end[];
 
 /* Start and end of .ctors section - used for constructor calls. */
 extern char __ctors_start[], __ctors_end[];
diff --git a/lib/Makefile b/lib/Makefile
index 2eef1eb80e..2ffec5a455 100644
--- a/lib/Makefile
+++ b/lib/Makefile
@@ -9,6 +9,7 @@ ifndef CONFIG_SPL_BUILD
 
 obj-$(CONFIG_EFI) += efi/
 obj-$(CONFIG_EFI_LOADER) += efi_loader/
+obj-$(CONFIG_EFI_LOADER) += efi_selftest/
 obj-$(CONFIG_LZMA) += lzma/
 obj-$(CONFIG_LZO) += lzo/
 obj-$(CONFIG_ZLIB) += zlib/
diff --git a/lib/efi_selftest/Makefile b/lib/efi_selftest/Makefile
new file mode 100644
index 0000000000..32598c2aea
--- /dev/null
+++ b/lib/efi_selftest/Makefile
@@ -0,0 +1,16 @@
+#
+# (C) Copyright 2016, Heinrich Schuchardt <xypron.glpk@gmx.de>
+#
+#  SPDX-License-Identifier:     GPL-2.0+
+#
+
+# This file only gets included with CONFIG_EFI_LOADER set, so all
+# object inclusion implicitly depends on it
+
+CFLAGS_selftest.o := $(CFLAGS_EFI)
+CFLAGS_REMOVE_selftest.o := $(CFLAGS_NON_EFI)
+
+efiprogs-$(CONFIG_CMD_BOOTEFI_SELFTEST_COMPILE) += selftest.efi
+always := $(efiprogs-y)
+
+obj-$(CONFIG_CMD_BOOTEFI_SELFTEST) += selftest.o
diff --git a/lib/efi_selftest/selftest.c b/lib/efi_selftest/selftest.c
new file mode 100644
index 0000000000..c071ef6250
--- /dev/null
+++ b/lib/efi_selftest/selftest.c
@@ -0,0 +1,24 @@
+/*
+ * EFI selftest
+ *
+ * Copyright (c) 2017 Heinrich Schuchardt <xypron.glpk@gmx.de>
+ *
+ * SPDX-License-Identifier:     GPL-2.0+
+ */
+
+#include <common.h>
+#include <part_efi.h>
+#include <efi_api.h>
+
+efi_status_t EFIAPI efi_main(efi_handle_t handle,
+			     struct efi_system_table *systable)
+{
+	struct efi_simple_text_output_protocol *con_out = systable->con_out;
+	struct efi_boot_services *boottime = systable->boottime;
+
+	con_out->output_string(con_out, L"Starting selftest\n");
+	con_out->output_string(con_out, L"Completed selftest\n");
+	boottime->exit(handle, 0, 0, NULL);
+
+	return EFI_SUCCESS;
+}
diff --git a/scripts/Makefile.lib b/scripts/Makefile.lib
index 9ce47b4d22..2b376ebbea 100644
--- a/scripts/Makefile.lib
+++ b/scripts/Makefile.lib
@@ -346,9 +346,9 @@ $(obj)/%.S: $(src)/%.ttf
 # ---------------------------------------------------------------------------
 
 # Generate an assembly file to wrap the EFI app
-cmd_S_efi=						\
+cmd_helloworld_efi=					\
 (							\
-	echo '.section .rodata.efi.init,"a"';		\
+	echo '.section .rodata.efi_hello.init,"a"';	\
 	echo '.balign 16';				\
 	echo '.global __efi_hello_world_begin';		\
 	echo '__efi_hello_world_begin:';		\
@@ -358,8 +358,8 @@ cmd_S_efi=						\
 	echo '.balign 16';				\
 ) > $@
 
-$(obj)/%_efi.S: $(obj)/%.efi
-	$(call cmd,S_efi)
+$(obj)/helloworld_efi.S: $(obj)/helloworld.efi
+	$(call cmd_helloworld_efi)
 
 quiet_cmd_efi_objcopy = OBJCOPY $@
 cmd_efi_objcopy = $(OBJCOPY) -j .header -j .text -j .sdata -j .data -j \
@@ -367,7 +367,7 @@ cmd_efi_objcopy = $(OBJCOPY) -j .header -j .text -j .sdata -j .data -j \
 		$(if $(EFI_TARGET),$(EFI_TARGET),-O binary) $^ $@
 
 $(obj)/%.efi: $(obj)/%.so
-	$(call cmd,efi_objcopy)
+	$(call cmd_efi_objcopy)
 
 quiet_cmd_efi_ld = LD      $@
 cmd_efi_ld = $(LD) -nostdlib -znocombreloc -T $(EFI_LDS_PATH) -shared \
@@ -381,6 +381,31 @@ $(obj)/helloworld.so: $(obj)/helloworld.o arch/$(ARCH)/lib/$(EFI_CRT0) \
 		arch/$(ARCH)/lib/$(EFI_RELOC)
 	$(call cmd,efi_ld)
 
+# EFI Selftest application
+# ---------------------------------------------------------------------------
+
+# Generate an assembly file to wrap the EFI app
+cmd_selftest_efi=					\
+(							\
+	echo '.section .rodata.efi_selftest.init,"a"';		\
+	echo '.balign 16';				\
+	echo '.global __efi_selftest_begin';		\
+	echo '__efi_selftest_begin:';			\
+	echo '.incbin "$<" ';				\
+	echo '__efi_selftest_end:';			\
+	echo '.global __efi_selftest_end';		\
+	echo '.balign 16';				\
+) >> $@
+
+$(obj)/selftest_efi.S: $(obj)/selftest.efi
+	$(call cmd_selftest_efi)
+
+$(obj)/selftest.so: $(EFI_LDS_PATH)
+
+$(obj)/selftest.so: $(obj)/selftest.o arch/$(ARCH)/lib/$(EFI_CRT0) \
+		arch/$(ARCH)/lib/$(EFI_RELOC)
+	$(call cmd,efi_ld)
+
 # ACPI
 # ---------------------------------------------------------------------------
 quiet_cmd_acpi_c_asl= ASL     $<
-- 
2.11.0

